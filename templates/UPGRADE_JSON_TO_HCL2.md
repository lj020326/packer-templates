
# Converting from json to hcl2 build file format

## Run script to convert json to hcl for all builds

```shell
$ cd templates
$ convert_json2hcl.sh 
Ignoring following initialization error: <nil>: ; 1 error occurred:
	* at least one builder must be defined

Successfully created common-vars.vars.json.pkr.hcl. Exit 0

```

## Run build template script - internally invokes convert_json2hcl.sh for all builds

```shell
$ cd templates
$ build_vm_template.sh 
Ignoring following initialization error: <nil>: ; 1 error occurred:
	* at least one builder must be defined

Successfully created common-vars.vars.json.pkr.hcl. Exit 0

```


## Converting variable files

Important: Unlike legacy JSON templates the input variables within a variable definitions file must be declared via a variables block within a standard HCL2 template file *.pkr.hcl before it can be assigned a value. Failure to do so will result in an unknown variable error during Packer's runtime.
 
Reference: https://developer.hashicorp.com/packer/docs/templates/hcl_templates/variables

For example, if using a common-vars.json similar to the following:
```json
{
  "build_type": "vsphere-iso",
  "vm_build_notes": "Build via Packer - date: {{ isotime }} - build tag: {{ env `BUILD_TAG` }}",
  "skip_packer_build": "false",
  "vcenter_host": "vcenter7.dettonville.int",
  "vcenter_username": "administrator@vsphere.local",
  "vcenter_password": "{{ env `VMWARE_VCENTER_PASSWORD` }}",
  "vcenter_datacenter": "dettonville-dc-01",
  "vcenter_cluster": "Management",
  "vcenter_folder": "templates",
  "vcenter_deploy_folder": "templates"
}
```

## 1) Move variables into `variables` block

Copy the json file and place into a variables block/map.

It should look like the following:
```json
{
  "variables": {
    "build_type": "vsphere-iso",
    "vm_build_notes": "Build via Packer - date: {{ isotime }} - build tag: {{ env `BUILD_TAG` }}",
    "skip_packer_build": "false",
    "vcenter_host": "vcenter7.dettonville.int",
    "vcenter_username": "administrator@vsphere.local",
    "vcenter_password": "{{ env `VMWARE_VCENTER_PASSWORD` }}",
    "vcenter_datacenter": "dettonville-dc-01",
    "vcenter_cluster": "Management",
    "vcenter_folder": "templates",
    "vcenter_deploy_folder": "templates"
  }
}
```

## 2) Run the package upgrade utility

```shell
$ packer hcl2_upgrade -with-annotations common-vars.vars.json 
Ignoring following initialization error: <nil>: ; 1 error occurred:
	* at least one builder must be defined

Successfully created common-vars.vars.json.pkr.hcl. Exit 0

```

Results:

common-vars.vars.json.pkr.hcl: 
```shell
# This file was autogenerated by the 'packer hcl2_upgrade' command. We
# recommend double checking that everything is correct before going forward. We
# also recommend treating this file as disposable. The HCL2 blocks in this
# file can be moved to other files. For example, the variable blocks could be
# moved to their own 'variables.pkr.hcl' file, etc. Those files need to be
# suffixed with '.pkr.hcl' to be visible to Packer. To use multiple files at
# once they also need to be in the same folder. 'packer inspect folder/'
# will describe to you what is in that folder.

# Avoid mixing go templating calls ( for example ```{{ upper(`string`) }}``` )
# and HCL2 calls (for example '${ var.string_value_example }' ). They won't be
# executed together and the outcome will be unknown.

# All generated input variables will be of 'string' type as this is how Packer JSON
# views them; you can change their type later on. Read the variables type
# constraints documentation
# https://www.packer.io/docs/templates/hcl_templates/variables#type-constraints for more info.

variable "build_type" {
  type    = string
  default = "vsphere-iso"
}

variable "vcenter_cluster" {
  type    = string
  default = "Management"
}

variable "vcenter_datacenter" {
  type    = string
  default = "dettonville-dc-01"
}

variable "vcenter_deploy_folder" {
  type    = string
  default = "templates"
}

variable "vcenter_folder" {
  type    = string
  default = "templates"
}

variable "vcenter_host" {
  type    = string
  default = "vcenter7.dettonville.int"
}

variable "vcenter_password" {
  type    = string
  default = "${env("VMWARE_VCENTER_PASSWORD")}"
}

variable "vcenter_username" {
  type    = string
  default = "administrator@vsphere.local"
}

# All locals variables are generated from variables that uses expressions
# that are not allowed in HCL2 variables.
# Read the documentation for locals blocks here:
# https://www.packer.io/docs/templates/hcl_templates/blocks/locals
locals {
  vm_build_notes = "Build via Packer - date: ${timestamp()} - build tag: ${env("BUILD_TAG")}"
}

```


## Extraneous/Other Useful Information

There is also an online json2hcl converter at `https://www.hcl2json.com/`
However, it does not auto-generate the variable definitions the way that the `packer hcl2_upgrade` command does.  

As such, since the definitions are required, use the packer utility to perform variable upgrade to hcl by simply observing the 2-step process documented in the prior section of this article. 

![](./../docs/screenshots/hcl2json.png)


```shell
tools/install_hcl2json.sh 
packer hcl2_upgrade -with-annotations common-vars.vars.json 
packer hcl2_upgrade -with-annotations build-config.json 
```

## Reference

- https://developer.hashicorp.com/packer/guides/hcl/variables
- https://www.virtualizationhowto.com/2022/06/convert-packer-variables-json-to-hcl2-for-automated-vsphere-builds/
- https://www.hcl2json.com/
